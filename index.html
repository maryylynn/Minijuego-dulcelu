<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MiniJuego Dulce L√∫</title>
  <style>
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #0b0b0b, #25001f);
      color: #fff;
      text-align: center;
    }
    h1 {
      margin-top: 20px;
      text-shadow: 0 0 10px #ff66c4;
    }
    #game-wrap{max-width:420px;margin:0 auto;padding:10px}
    #game {
      margin: 20px auto;
      width: 400px;
      height: 400px;
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(6px);
      border-radius: 25px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 0 30px #ff3fa8;
      touch-action: manipulation;
    }

    #alfajor {
      width: 90px;
      height: 90px;
      background: radial-gradient(circle, #6e3f22 40%, #4e2d12 100%);
      border-radius: 50%;
      position: absolute;
      cursor: pointer;
      box-shadow: 0 0 15px #ff88dd;
      transition: transform 0.15s;
      /* ensure there is a default left/top so parseInt works */
      left: 0px;
      top: 0px;
      display:flex;align-items:center;justify-content:center;font-weight:bold
    }

    #score, #timer {
      font-size: 22px;
      margin-top: 10px;
      text-shadow: 0 0 6px #ff5dc8;
    }

    /* Part√≠culas */
    .particle {
      position: absolute;
      font-size: 20px;
      animation: fly 0.8s ease-out forwards;
      pointer-events: none;
      user-select: none;
    }

    @keyframes fly {
      0% { opacity: 1; transform: translateY(0) scale(1); }
      100% { opacity: 0; transform: translateY(-50px) scale(1.5); }
    }

    /* Buttons */
    #controls{display:flex;gap:10px;justify-content:center;margin-top:10px}
    button{padding:8px 12px;border-radius:10px;border:none;cursor:pointer}
  </style>
</head>
<body>
  <div id="game-wrap">
    <h1>üç´ Mini Juego ‚Äî Atrapa el Alfajor Dulce L√∫ ‚ú®</h1>
    <p>Toca el alfajor antes de que desaparezca. ¬°Corre!</p>

    <div id="timer">‚è± Tiempo: 30</div>
    <div id="score">Puntaje: 0</div>

    <div id="game">
      <div id="alfajor" aria-label="alfajor"> </div>
    </div>

    <div id="controls">
      <button id="restart">Reiniciar</button>
      <button id="fullscreen">Pantalla completa</button>
    </div>
  </div>

  <script>
    // Elements
    const alfajor = document.getElementById('alfajor');
    const scoreText = document.getElementById('score');
    const timerText = document.getElementById('timer');
    const game = document.getElementById('game');
    const restartBtn = document.getElementById('restart');
    const fsBtn = document.getElementById('fullscreen');

    // Game state
    let score = 0;
    let time = 30;
    let baseSpeed = 900; // ms between moves
    let minSpeed = 300;
    let moveTimeoutId = null;
    let timerIntervalId = null;
    let gameRunning = false;

    // Audio: some environments (sandbox) may disallow creating/playing audio from external URLs.
    // We'll attempt to create Audio but wrap in try/catch and provide a safe no-op fallback.
    let sounds = { pop: null };
    try {
      // try to create audio, but if it fails we'll set play() to a noop
      const audio = new Audio('https://actions.google.com/sounds/v1/cartoon/pop.ogg');
      // don't auto-play; only play on user interaction
      sounds.pop = audio;
    } catch (err) {
      sounds.pop = { play: () => {} };
    }

    // Utility: get random position inside game for alfajor (keeps it fully visible)
    function randomPosition() {
      const gw = game.clientWidth;
      const gh = game.clientHeight;
      const aw = alfajor.clientWidth;
      const ah = alfajor.clientHeight;
      const x = Math.max(0, Math.random() * (gw - aw));
      const y = Math.max(0, Math.random() * (gh - ah));
      return { x, y };
    }

    // Move alfajor and schedule next move according to current speed (depends on score)
    function scheduleNextMove() {
      // clear previous timeout if exists
      if (moveTimeoutId) clearTimeout(moveTimeoutId);

      // compute current speed: faster as score increases
      const speed = Math.max(minSpeed, baseSpeed - Math.floor(score / 5) * 50);

      moveTimeoutId = setTimeout(() => {
        moverAlfajor();
        // schedule again
        scheduleNextMove();
      }, speed);
    }

    function moverAlfajor() {
      const pos = randomPosition();
      alfajor.style.left = pos.x + 'px';
      alfajor.style.top = pos.y + 'px';
    }

    // Create particles at absolute coordinates (relative to game container)
    function crearParticulas(absX, absY) {
      for (let i = 0; i < 6; i++) {
        const p = document.createElement('div');
        p.classList.add('particle');
        p.textContent = ['‚ú®', '‚òÖ', '‚ù§'][Math.floor(Math.random()*3)];
        p.style.left = (absX + (Math.random()*20 - 10)) + 'px';
        p.style.top = (absY + (Math.random()*20 - 10)) + 'px';
        p.style.color = ['#ff82d9', '#ffcae9', '#ff4fa7'][Math.floor(Math.random()*3)];
        game.appendChild(p);
        setTimeout(() => p.remove(), 900);
      }
    }

    // When alfajor is clicked/tapped
    function onCatch(e) {
      // increase score
      score++;
      scoreText.textContent = 'Puntaje: ' + score;

      // visual feedback
      alfajor.style.transform = 'scale(1.15)';
      setTimeout(() => (alfajor.style.transform = 'scale(1)'), 120);

      // try to play sound safely
      try { if (sounds.pop && typeof sounds.pop.play === 'function') sounds.pop.play(); } catch(e) {}

      // compute particle position: use bounding rect of alfajor relative to game
      const alfRect = alfajor.getBoundingClientRect();
      const gameRect = game.getBoundingClientRect();
      const absX = alfRect.left - gameRect.left + alfRect.width / 2 - 10;
      const absY = alfRect.top - gameRect.top + alfRect.height / 2 - 10;
      crearParticulas(absX, absY);

      // immediately move the alfajor and reschedule moves (speed will adapt automatically)
      moverAlfajor();
    }

    // Timer logic
    function startTimer() {
      if (timerIntervalId) clearInterval(timerIntervalId);
      timerIntervalId = setInterval(() => {
        time--;
        timerText.textContent = '‚è± Tiempo: ' + time;
        if (time <= 0) {
          endGame();
        }
      }, 1000);
    }

    function startGame() {
      // reset state
      score = 0;
      time = 30;
      scoreText.textContent = 'Puntaje: ' + score;
      timerText.textContent = '‚è± Tiempo: ' + time;
      gameRunning = true;
      alfajor.style.display = '';

      // move once immediately and then schedule
      moverAlfajor();
      scheduleNextMove();
      startTimer();
    }

    function endGame() {
      gameRunning = false;
      if (moveTimeoutId) clearTimeout(moveTimeoutId);
      if (timerIntervalId) clearInterval(timerIntervalId);
      alfajor.style.display = 'none';
      setTimeout(() => alert('üéâ Fin del juego! Puntaje final: ' + score), 100);
    }

    // Restart button
    restartBtn.addEventListener('click', () => {
      if (moveTimeoutId) clearTimeout(moveTimeoutId);
      if (timerIntervalId) clearInterval(timerIntervalId);
      startGame();
    });

    // Fullscreen button
    fsBtn.addEventListener('click', async () => {
      try {
        if (!document.fullscreenElement) await game.requestFullscreen();
        else await document.exitFullscreen();
      } catch(err) {
        console.warn('Fullscreen not supported', err);
      }
    });

    // Attach event listeners
    alfajor.addEventListener('click', onCatch);
    // also support touch on mobile large hit area
    alfajor.addEventListener('touchstart', function(e){ e.preventDefault(); onCatch(e); }, {passive:false});

    // Start the game automatically on first user interaction (to allow audio play in some browsers)
    function onFirstInteraction() {
      document.removeEventListener('click', onFirstInteraction);
      document.removeEventListener('touchstart', onFirstInteraction);
      startGame();
    }
    document.addEventListener('click', onFirstInteraction);
    document.addEventListener('touchstart', onFirstInteraction, {passive:true});

    // Initial placement so parseInt won't return NaN anywhere
    (function initPlacement(){
      const pos = randomPosition();
      alfajor.style.left = pos.x + 'px';
      alfajor.style.top = pos.y + 'px';
    })();
  </script>
</body>
</html>
